# docker 容器数据卷

### 1.什么是docker容器数据卷

在之前我们使用不管是nginx容器还是mysql容器，都有一个很大的问题，容器的数据和外部主机怎么交互，难道我把容器删除后容器的数据都没了吗？你当然可以用docker cp命令把容器的数据备份在容器外，但是这样不是非常麻烦吗？为此容器数据卷出现了，Docker 容器数据卷（Container Volumes）是一种特殊的文件或目录，用于在容器和宿主机之间持久化存储和共享数据。数据卷可以在容器创建时挂载到容器的指定路径，并且可以在多个容器之间共享和访问。

### 2.怎么使用dacker容器数据卷

我们可以在创建容器的时候就可以创建数据卷了，其实也就是docker run命令，我们只需要在docker run命令后加 -v 或者 --mount参数就行了。他会将主机的目录挂载到容器的指定目录上，这样就实现了主机和容器的数据同步和持久化了。

**docker run -v [主机目录]:[挂载到容器的目录]**

示例：

`docker run -d -p 8081:3306 -v /tmp/mysqltest/conf:/etc/mysql/conf.d -v /tmp/mysqltest/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root --name mysqltest  mysql`

-d：后台运行容器

-p：端口的映射

-v：数据卷挂载

-e：配置

--name：给这个容器起个名字

### 3.docker volume 命令

上面提到在挂载的时候会创建数据卷还有其他方式可以创建数据卷

Docker 提供了 `docker volume` 命令来管理和操作容器数据卷。以下是一些常用的 `docker volume` 命令及其功能，详细的命令选项和用法可以通过 `docker volume --help`：

1. 创建一个数据卷：
   
   ```
   docker volume create <volume_name>
   ```
   
   该命令用于创建一个新的具名数据卷，可以指定 `<volume_name>` 作为数据卷的名称。

2. 列出所有数据卷：
   
   ```
   docker volume ls
   ```
   
   该命令用于列出所有已创建的数据卷，显示数据卷的名称和驱动程序。

3. 查看数据卷的详细信息：
   
   ```
   docker volume inspect <volume_name>
   ```
   
   该命令用于查看指定数据卷的详细信息，包括名称、挂载点、创建时间等。

4. 删除一个数据卷：
   
   ```
   docker volume rm <volume_name>
   ```
   
   该命令用于删除指定的数据卷。

5. 删除未使用的数据卷：
   
   ```
   docker volume prune
   ```
   
   该命令用于删除未被任何容器使用的所有数据卷。

### 4.挂载方式

1. **指定路径挂载**
   
   上面展示的示例其实就是指定路径挂载，就不多赘述了。
   
   可以通过docker inspect [容器id]看挂载地址
   
   ```shell
   "Mounts": [
               {
                   "Type": "bind",
                   "Source": "/tmp/mysqltest/conf",
                   "Destination": "/etc/mysql/conf.d",
                   "Mode": "",
                   "RW": true,
                   "Propagation": "rprivate"
               },
               {
                   "Type": "bind",
                   "Source": "/tmp/mysqltest/data",
                   "Destination": "/var/lib/mysql",
                   "Mode": "",
                   "RW": true,
                   "Propagation": "rprivate"
               }
           ],
   ```

2. **具名和匿名挂载**
   
   - 具名挂载
     
     具名挂载是通过指定数据卷的名称将宿主机的目录或文件挂载到容器内部的指定路径上。
     
     格式为：`-v <volume_name>:<container_path>`。
     
     示例：`docker run -v my_volume:/data ...` 将名为 `my_volume` 的数据卷挂载到容器的 `/data` 路径上。
   
   - 匿名挂载
     
     没有指定宿主机的路径，这种情况下，Docker 会自动为容器创建一个匿名卷，并将它挂载到指定的容器路径上。宿主机的路径将由 Docker 自动分配，并且在容器创建时无法直接获取到它。
     
     格式为：`-v <container_path>`
     
     示例：`docker run -v /data ...` 将名为 匿名的数据卷挂载到容器的 /data 路径上。
   
   我们一般不使用匿名挂载，一般是测试或者只用一个的场景使用
   
   具名挂载的时候我们怎么知道我们的数据卷具体是在哪个地址呢？可以用`docker volume inspect [卷名]` 来看到挂载点(Mountpoint)的地址，在那就会我我们具体的挂载目录
   
   ```shell
   [root@mantouCentOS7 volumes]# docker volume inspect nginxjuan 
   [
       {
           "CreatedAt": "2024-05-27T21:41:59+08:00",
           "Driver": "local",
           "Labels": null,
           "Mountpoint": "/var/lib/docker/volumes/nginxjuan/_data",
           "Name": "nginxjuan",
           "Options": null,
           "Scope": "local"
       }
   ]
   ```

3. **在dockerfile的时候挂载**
   
   首先简单的介绍一下什么是dockerfile
   
   Dockerfile 是一种文本文件，用于定义 Docker 镜像的构建过程。它包含了一系列的指令和配置。简单来说就是可以创建镜像的脚本。
   
   言归正传我们来将将怎么在dockerfile中配置挂载
   
   首先我们找地方建一个名为dockerfile的文件，在写一段脚本命令 指令大写 命令小写
   
   ```shell
   [root@mantouCentOS7 tmp]# mkdir dockerfiletest
   [root@mantouCentOS7 tmp]# cd dockerfiletest/
   [root@mantouCentOS7 dockerfiletest]# touch dockerfile
   [root@mantouCentOS7 dockerfiletest]# vim dockerfile 
   [root@mantouCentOS7 dockerfiletest]# cat dockerfile 
   FROM centos
   
   VOLUME ["volume01", "volume02"]
   
   CMD echo "---------------------build end-----------------------"
   CMD
   ```
   
   然后用docker build命令去构建镜像
   
   `docker build `
   
   `docker build -f dockerfile -t my_first_image:1.0 .`
   
   -f: dockerfile的文件地址
   
   -t: 给这个镜像起个名字和版本标签
   
   . : 指定上下文为当前目录
   
   然后就有镜像了，可以用docker images看
   
   最后用docker run启动这个镜像，可以看到有两个数据卷的挂载目录volume01和volume02，在退出容器，用docker inspect 看这个挂载情况，可以知道他是一个匿名挂载
   
   ```shell
   "Mounts": [
               {
                   "Type": "volume",
                   "Name": "efe689aac0f1bd38e8d7464affe15378e9fc8e6652dfa2ae8c0aa18deb7032d9",
                   "Source": "/var/lib/docker/volumes/efe689aac0f1bd38e8d7464affe15378e9fc8e6652dfa2ae8c0aa18deb7032d9/_data",
                   "Destination": "volume01",
                   "Driver": "local",
                   "Mode": "",
                   "RW": true,
                   "Propagation": ""
               },
               {
                   "Type": "volume",
                   "Name": "da1b6cc80ad361a38f5da846b07c1465e4767222c19ff4d9190b352ac1b9822c",
                   "Source": "/var/lib/docker/volumes/da1b6cc80ad361a38f5da846b07c1465e4767222c19ff4d9190b352ac1b9822c/_data",
                   "Destination": "volume02",
                   "Driver": "local",
                   "Mode": "",
                   "RW": true,
                   "Propagation": ""
               }
   ```

### 5.挂载的时候加权限

在使用 `-v` 参数或 `--mount` 参数进行挂载时，可以指定权限选项。以下是一些常用的权限选项：

1. 读写权限（Read-Write Permissions）：
   
   - `rw`：允许容器内的进程对挂载的目录进行读取和写入操作（默认选项）。
   - 示例：`docker run -v /host/data:/data:rw ...`

2. 只读权限（Read-Only Permissions）：
   
   - `ro`：将挂载的目录设置为只读，容器内的进程只能读取该目录，无法进行写入操作。
   - 示例：`docker run -v /host/data:/data:ro ...`

通过在挂载选项中添加 `:rw` 或 `:ro`，可以指定挂载的权限。

需要注意的是，这些权限选项只适用于整个挂载点，而不是单个文件或子目录。如果您希望在挂载时对特定文件或子目录设置权限，可以使用其他工具或命令在容器内设置适当的权限。

请注意，具体的权限可能会受到宿主机上文件系统的限制。例如，在宿主机上如果文件或目录的权限不允许容器内的进程进行读写操作，那么即使在挂载时指定了读写权限，容器内的进程也无法修改这些权限。

### 6.数据卷容器

数据卷容器实际上是一个专门用于存储数据的容器，它创建了一个或多个数据卷，并将这些数据卷挂载到需要访问数据的其他容器中。这种模式的主要优势是可以将数据卷从容器中分离出来，使得数据的管理更加灵活和独立。

也就是说容器和容器之间同步消息，通过在docker run 命令后接选项 `--volume-from`

如果容器A挂载到容器B 那就是B为父容器 `docker run A --volume-from B`

通过这种方式，数据卷容器提供了一种有效的方法来管理和共享数据。数据卷容器本身不运行任何应用程序，而只是用于存储和管理数据。可以通过挂载数据卷容器来访问其中的数据，从而实现数据的持久性和共享性。
